<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () { (m[i].a = m[i].a || []).push(arguments) };
            m[i].l = 1 * new Date(); k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(k, a)
        })
            (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

        ym(80552305, "init", {
            clickmap: true,
            trackLinks: true,
            accurateTrackBounce: true,
            webvisor: true
        });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/80552305" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
</head>
<body>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.css">
    <script src="scripts/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.8.7/dist/semantic.min.js"></script>
    <style>
        .bold {
            font-weight: bold;
        }

        td.lightGray, th.lightGray {
            background-color: #EEE !important;
        }

        tr:hover > td.lightGray {
            background-color: #DDD;
        }
    </style>
    <script>
        $(document).ready(() => {
            $('.ui.accordion').accordion();

            // Включаем анимацию для цифр общей статистики
            $('.count').each(function () {
                $(this).prop('Counter', 0).animate({
                    Counter: $(this).text()
                },
                    {
                        duration: 1000,
                        easing: 'swing',
                        step: function (now) {
                            this.innerHTML = Math.ceil(now).toString().replace(/(\d)(?=(\d{3})+(\D|$))/g, '$1&thinsp;');
                        }
                    });
            });

            // Клик на кнопке Поиск в главном блоке
            $(".main-seach-button").on("click", () => {
                $(".dimmer").dimmer({
                    closable: false
                }).dimmer("show");

                var id = $(".main-chess-id").val();
                loadResults(id,
                    // Успешная загрузка
                    () => {
                        setTimeout(() => {
                            $(".contacts").hide();
                            $(".dimmer").dimmer("hide");
                            $("#main-search").css("display", "none");
                            $("#content").fadeIn(100);
                        }, 300);
                        $(".head-chess-id").val(id);
                    },
                    // Не успешная загрузка
                    () => {
                        setTimeout(() => {
                            $(".dimmer").dimmer("hide");
                        }, 300);
                    })
            })

            $(".head-seach-button").on("click", (item) => {
                $(".dimmer").dimmer({
                    closable: false
                }).dimmer("show");
                loadResults($(item.target).parent().children(".head-chess-id").val(),
                    // Успешная загрузка
                    () => {
                        setTimeout(() => {
                            $(".dimmer").dimmer("hide");
                        }, 300);
                    },
                    // Не успешная загрузка
                    () => {
                        setTimeout(() => {
                            $(".dimmer").dimmer("hide");
                        }, 300);
                    })
            })
        })

        function loadResults(chessId, successCallBack, errorCallBack) {
            $.ajax({
                url: 'stat',
                data: "chessId=" + chessId,
                success: function (result) {
                    if (result == null || result == 'null') {
                        $('body')
                            .toast({
                                displayTime: 10000,
                                class: 'error',
                                message: `Произошла ошибка. Попробуйте позже или напишите мне <a href='mailto:byte916@yandex.ru'>по почте</a> или <a href='https://vk.com/id2962981' target='_blank'>во вконтакте</a>`
                            });
                        return errorCallBack();
                    }
                    successCallBack();
                    showResult(result);
                },
                error: function () {
                    errorCallBack();
                    $('body')
                        .toast({
                            displayTime: 10000,
                            class: 'error',
                            message: `Произошла ошибка. Попробуйте позже или напишите мне <a href='mailto:byte916@yandex.ru'>по почте</a> или <a href='https://vk.com/id2962981' target='_blank'>во вконтакте</a>`
                        });
                }
            });
        }

        function showResult(result) {
            fillOpponents(result.rivals);
            fillCommonStats(result.info);
            fillColorStrength(result.gameStrengths);
            fillHardestGames(result.hardestRivals);
            fillTournamentsStats(result.tournamentStats);
            fillInconenientOpponents(result.inconvenientOpponent);
        }

        function fillCommonStats(commonStats) {
            $("#name").html(commonStats.name);
            $("#games").text(commonStats.games);
            $("#wins").text(commonStats.wins);
            $("#draws").text(commonStats.draws);
            $("#loses").text(commonStats.loses);
        }
        function fillOpponents(rivals) {
            // Заполняем топ-частых соперников
            var opponentsTable = $("#opponents");
            opponentsTable.html("");
            var index = 1;
            rivals.forEach(rival => {
                // Если процент набранных очков 50% или больше - подсвечиваем зеленым
                var isGoodResult = rival.wins + rival.draws / 2 >= rival.games / 2
                var row = $("<tr/>");
                if (isGoodResult) row.addClass("left marked green");
                else row.addClass("left marked red");
                row.append(addCell('#' + index++));

                row.append(addCell('<a href="' + getRivalHref(rival.id) + '" target="_blank">' + rival.name + '</a>'));
                row.append(addCell(rival.games));
                row.append(addCell(rival.wins == 0 ? '' : rival.wins, rival.wins > rival.draws && rival.wins > rival.loses, "green"));
                row.append(addCell(rival.draws == 0 ? '' : rival.draws, rival.draws > rival.wins && rival.draws > rival.loses, "orange"));
                row.append(addCell(rival.loses == 0 ? '' : rival.loses, rival.loses > rival.draws && rival.loses > rival.wins, "red"));
                opponentsTable.append(row);
            });
        }
        function fillColorStrength(gameStrengths) {
            var gameStrengthsTable = $("#gameStrengths");
            gameStrengthsTable.html("");

            var totalWinsWhite = 0;
            var totalWinsBlack = 0;
            var totalDrawsWhite = 0;
            var totalDrawsBlack = 0;
            var totalLosesWhite = 0;
            var totalLosesBlack = 0;

            gameStrengths.forEach(rivals => {
                var row = $("<tr/>");
                switch (rivals.strength) {
                    case 0:
                        row.append("<td style='text-align: left;'><strong>Слабые</strong></td>");
                        break;
                    case 1:
                        row.append("<td style='text-align: left;'><strong>Равные</strong></td>");
                        break;
                    case 2:
                        row.append("<td style='text-align: left;'><strong>Сильные</strong></td>");
                        break;
                }
                var whitePointPercent = Math.round(rivals.white.points * 100 / rivals.white.games);
                var blackPointPercent = Math.round(rivals.black.points * 100 / rivals.black.games);
                totalWinsWhite += rivals.white.wins;
                totalWinsBlack += rivals.black.wins;
                totalDrawsWhite += rivals.white.draws;
                totalDrawsBlack += rivals.black.draws;
                totalLosesWhite += rivals.white.loses;
                totalLosesBlack += rivals.black.loses;
                var totalWhite = rivals.white.wins + rivals.white.draws + rivals.white.loses;
                var totalBlack = rivals.black.wins + rivals.black.draws + rivals.black.loses;

                row.append(addCell(totalWhite));
                row.append(addCell(totalBlack, null, null, 'lightGray'));

                var isWhiteWinsBest = isBestValue(rivals.white.wins, rivals.black.wins, totalWhite, totalBlack);
                var isWhiteDrawBest = isBestValue(rivals.white.draws, rivals.black.draws, totalWhite, totalBlack);
                var isWhiteLoseBest = !isBestValue(rivals.white.loses, rivals.black.loses, totalWhite, totalBlack);
                var isWhitePercentBest = whitePointPercent > blackPointPercent;

                row.append(addCell(rivals.white.wins, isWhiteWinsBest, isWhiteWinsBest ? 'green' : ''));
                row.append(addCell(rivals.black.wins, !isWhiteWinsBest, !isWhiteWinsBest ? 'green' : '', 'lightGray'));
                row.append(addCell(rivals.white.draws, isWhiteDrawBest, isWhiteDrawBest ? 'orange' : ''));
                row.append(addCell(rivals.black.draws, !isWhiteDrawBest, !isWhiteDrawBest ? 'orange' : '', 'lightGray'));
                row.append(addCell(rivals.white.loses, isWhiteLoseBest, isWhiteLoseBest ? 'red' : ''));
                row.append(addCell(rivals.black.loses, !isWhiteLoseBest, !isWhiteLoseBest ? 'red' : '', 'lightGray'));
                row.append(addCell(whitePointPercent + "%", isWhitePercentBest, isWhitePercentBest ? 'green' : ''));
                row.append(addCell(blackPointPercent + "%", !isWhitePercentBest, !isWhitePercentBest ? 'green' : '', 'lightGray'));
                gameStrengthsTable.append(row);
            })

            var totalWhiteGames = totalWinsWhite + totalDrawsWhite + totalLosesWhite;
            var totalBlackGames = totalWinsBlack + totalDrawsBlack + totalLosesBlack;
            var whitePointPercent = Math.ceil((totalWinsWhite + totalDrawsWhite / 2) * 100 / (totalWinsWhite + totalDrawsWhite + totalLosesWhite));
            var blackPointPercent = Math.ceil((totalWinsBlack + totalDrawsBlack / 2) * 100 / (totalWinsBlack + totalDrawsBlack + totalLosesBlack));

            var isWhiteWinsBest = isBestValue(totalWinsWhite, totalWinsBlack, totalWhiteGames, totalBlackGames);
            var isWhiteDrawBest = isBestValue(totalDrawsWhite, totalDrawsBlack, totalWhiteGames, totalBlackGames);
            var isWhiteLoseBest = !isBestValue(totalLosesWhite, totalLosesBlack, totalWhiteGames, totalBlackGames);
            var isWhitePercentBest = whitePointPercent > blackPointPercent;

            var totalRow = $("<tr/>");
            totalRow.append("<td style='text-align: left;'><strong>Итого</strong></td>");
            totalRow.append(addCell(totalWhiteGames));
            totalRow.append(addCell(totalBlackGames, null, null, 'lightGray'));
            totalRow.append(addCell(totalWinsWhite, totalWinsWhite > totalWinsBlack, totalWinsWhite > totalWinsBlack ? 'green' : ''));
            totalRow.append(addCell(totalWinsBlack, totalWinsWhite < totalWinsBlack, totalWinsWhite < totalWinsBlack ? 'green' : '', 'lightGray'));
            totalRow.append(addCell(totalDrawsWhite, totalDrawsWhite > totalDrawsBlack, totalDrawsWhite > totalDrawsBlack ? 'orange' : ''));
            totalRow.append(addCell(totalDrawsBlack, totalDrawsWhite < totalDrawsBlack, totalDrawsWhite < totalDrawsBlack ? 'orange' : '', 'lightGray'));
            totalRow.append(addCell(totalLosesWhite, totalLosesWhite < totalLosesBlack, totalLosesWhite < totalLosesBlack ? 'red' : ''));
            totalRow.append(addCell(totalLosesBlack, totalLosesWhite > totalLosesBlack, totalLosesWhite > totalLosesBlack ? 'red' : '', 'lightGray'));
            totalRow.append(addCell(whitePointPercent + "%", isWhitePercentBest, isWhitePercentBest ? 'green' : ''));
            totalRow.append(addCell(blackPointPercent + "%", !isWhitePercentBest, !isWhitePercentBest ? 'green' : '', 'lightGray'));
            gameStrengthsTable.append(totalRow);
        }
        // Проверяет, является ли текущий показатель лучше другого, учитывая соотношения общего количества игр.
        function isBestValue(current, other, currentTotal, otherTotal) {
            if (currentTotal == 0 && otherTotal == 0) return null;
            if (currentTotal == 0) currentTotal = 1;
            if (otherTotal == 0) otherTotal = 1;
            return current / currentTotal >= other / otherTotal;
        }

        function getRivalHref(id) {
            if (id == null) return id;
            if (id.indexOf("ratings.fide") == -1) return 'https://ratings.ruchess.ru/people/' + id;
            return id;
        }

        function fillHardestGames(hardestRivals) {
            // Заполняем топ-сложных соперников
            var hardestGames = $("#hardestGames");
            hardestGames.html("");
            index = 1;
            hardestRivals.forEach(rival => {
                var row = $("<tr/>");
                row.append(addCell('#' + index++));
                row.append(addCell('<a href="' + getRivalHref(rival.id) + '" target="_blank">' + rival.name + '</a>'));
                row.append(addCell(rival.playerElo));
                row.append(addCell(rival.elo));
                row.append(addCell(rival.date));
                row.append(addCell(rival.tournament));
                row.append(addCell(rival.color, null, null, rival.color == "Черные" ? "lightGray" : null));
                row.append(addCell(rival.result, null, null, rival.result == "1" ? "green" : "olive"))
                hardestGames.append(row);
            });
        }
        function fillTournamentsStats(tournamentStats) {
            // Сила игры по ходу турнира
            var toursStats = $("#toursStats");
            toursStats.html("");
            tournamentStats.forEach(tours => {
                toursStats.append("<strong>Турнир из " + tours.length + " туров</strong>")
                var table = $('<table class="ui unstackable selectable right aligned table">');
                var thead = $('<thead>');
                var tbody = $('<tbody>');
                var tourRow = $('<tr>');
                var eloRow = $('<tr>');
                var percentRow = $('<tr>');
                var winsRow = $('<tr>');
                var drawsRow = $('<tr>');
                var losesRow = $('<tr>');
                var gamesRow = $('<tr>');

                var index = 1;
                tourRow.append('<th></th>');
                eloRow.append('<td>Средний ЭЛО соперников</td>');
                percentRow.append('<td>% набранных очков</td>');
                winsRow.append('<td>Побед</td>');
                drawsRow.append('<td>Ничьих</td>');
                losesRow.append('<td>Поражений</td>');
                gamesRow.append('<td>Всего Игр</td>');

                tours.forEach(tour => {
                    tourRow.append('<th>' + index++ + '</th>');
                    eloRow.append('<td>' + tour.avgElo + '</td>');

                    var percentColor = ''
                    if (tour.pointPercent >= 75) percentColor = 'green';
                    else if (tour.pointPercent >= 50) percentColor = 'olive';
                    else if (tour.pointPercent >= 25) percentColor = 'yellow';
                    else percentColor = 'orange';
                    percentRow.append('<td class="' + percentColor + '">' + tour.pointPercent + '%</td>');
                    winsRow.append('<td>' + tour.wins + '</td>');
                    drawsRow.append('<td>' + tour.draws + '</td>');
                    losesRow.append('<td>' + tour.loses + '</td>');
                    gamesRow.append('<td>' + tour.games + '</td>');
                })
                thead.append(tourRow);
                tbody.append(eloRow);
                tbody.append(percentRow);
                tbody.append(winsRow);
                tbody.append(drawsRow);
                tbody.append(losesRow);
                tbody.append(gamesRow);

                table.append(thead);
                table.append(tbody);

                toursStats.append(table);
            })
        }
        function fillInconenientOpponents(inconvenientOpponent) {
            // Неудобные соперники
            var inconvenientOpponentTable = $("#inconvenientOpponent");
            inconvenientOpponentTable.html('');
            index = 1;
            inconvenientOpponent.forEach(op => {
                var row = $("<tr>");
                row.append(addCell(index++));
                row.append(addCell('<a href="' + getRivalHref(op.id) + '" target="_blank">' + op.name + '</a>'));
                row.append(addCell(Math.ceil(100 * op.points / op.games)));
                row.append(addCell(op.wins == 0 ? '' : op.wins, null, "green"));
                row.append(addCell(op.draws == 0 ? '' : op.draws, null, "orange"));
                row.append(addCell(op.loses == 0 ? '' : op.loses, null, "red"));
                row.append(addCell(op.games));
                inconvenientOpponentTable.append(row);
            })
        }
        function addCell(data, isStrong, colorText, colorBack) {
            var style = 'ui';
            if (colorText != null) style = style + ' text ' + colorText;

            var cell = $("<td/>");

            if (colorBack != null) cell.addClass(colorBack);
            if (isStrong) style = style + ' bold'
            data = "<span class='" + style + "'>" + data + "</strong>";
            cell.html(data);
            return cell;
        }
    </script>
    <div class="ui page dimmer">
        <div class="ui text loader">Подождите, идёт загрузка...</div>
    </div>
    <div style="height: 78%;" id="main-search" class="ui middle aligned center aligned grid">
        <div style="width: auto;" class="column">
            <div class="ui unstackable form">
                <h1 class="ui header">Статистика ФШР</h1>
                <div class="ui hidden divider"></div>
                <div class="ui hidden divider"></div>
                <div class="fields" style="margin-bottom: 0">
                    <div class="field">
                        <input class="main-chess-id" type="text" placeholder="ID РШФ" />
                    </div>
                    <div class="field">
                        <input class="ui green main-seach-button button" type="button" value="Получить" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="content" style="display: none">
        <!-- Шапка -->
        <div class="ui vertical segment">
            <div class="ui container">
                <div class="ui two columns stackable grid">
                    <div class="tablet computer only column">
                        <h1 class="ui header">
                            <i class="circular small chess king icon"></i>
                            <div class="content">Статистика ФШР</div>
                        </h1>
                    </div>
                    <div class="center aligned mobile only column">
                        <h1 class="ui header">
                            <i class="circular small chess king icon"></i>
                            <div class="content">Статистика ФШР</div>
                        </h1>
                    </div>
                    <div class="tablet computer only right aligned column">
                        <div class="ui right action left icon input">
                            <i class="search icon"></i>
                            <input type="text" class="head-chess-id" placeholder="ID РШФ" />
                            <button class="ui green head-seach-button button">Получить</button>
                        </div>
                    </div>
                    <div class="mobile only center aligned column">
                        <div class="ui right action left icon input">
                            <i class="search icon"></i>
                            <input type="text" class="head-chess-id" placeholder="ID РШФ" />
                            <button class="ui green head-seach-button button">Получить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ui vertical placeholder segment">
            <div class="ui center aligned container">
                <h2 id="name"></h2>
                <div class="ui hidden divider"></div>
                <div class="ui hidden divider"></div>
            </div>
            <!-- Общая статистика -->
            <div id="common-stats" class="ui center aligned relaxed grid container">
                <div class="eight wide mobile four wide tablet four wide computer column">
                    <div class="ui statistic">
                        <div id="games" class="value count">0</div>
                        <div class="label">Игр</div>
                    </div>
                </div>
                <div class="eight wide mobile four wide tablet four wide computer column">
                    <div class="ui statistic">
                        <div id="wins" class="value count">0</div>
                        <div class="label">Побед</div>
                    </div>
                </div>
                <div class="eight wide mobile four wide tablet four wide computer column">
                    <div class="ui statistic">
                        <div id="draws" class="value count">0</div>
                        <div class="label">Ничьих</div>
                    </div>
                </div>
                <div class="eight wide mobile four wide tablet four wide computer column">
                    <div class="ui statistic">
                        <div id="loses" class="value count">0</div>
                        <div class="label">Поражений</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="ui vertical segment">
            <div class="ui container">
                <div class="ui fluid accordion">
                    <div class="title">
                        <i class="dropdown icon"></i>
                        Сила игры и цвет
                    </div>
                    <div class="content">
                        <table class="ui unstackable selectable table">
                            <thead>
                                <tr>
                                    <th rowspan="2">Соперники</th>
                                    <th colspan="2" style="text-align: center">Игр</th>
                                    <th colspan="2" style="text-align: center">Побед</th>
                                    <th colspan="2" style="text-align: center">Ничьих</th>
                                    <th colspan="2" style="text-align: center">Поражений</th>
                                    <th colspan="2" style="text-align: center">% очков</th>
                                </tr>
                                <tr>
                                    <th style="text-align: right">Б</th>
                                    <th class="lightGray" style="text-align: right">Ч</th>
                                    <th style="text-align: right">Б</th>
                                    <th class="lightGray" style="text-align: right">Ч</th>
                                    <th style="text-align: right">Б</th>
                                    <th class="lightGray" style="text-align: right">Ч</th>
                                    <th style="text-align: right">Б</th>
                                    <th class="lightGray" style="text-align: right">Ч</th>
                                    <th style="text-align: right">Б</th>
                                    <th class="lightGray" style="text-align: right">Ч</th>
                                </tr>
                            </thead>
                            <tbody id="gameStrengths" class="right aligned"></tbody>
                        </table>
                        <div class="ui ordered list">
                            <div class="item">Равным считается соперник с рейтингом +/- 50 пунктов ЭЛО</div>
                            <div class="item">В статистике не участвуют соперники с рейтингом равным ровно 1000 ЭЛО</div>
                            <div class="item">Цветом в таблице выделены лучшие показатели (с учетом соотношения игр)</div>
                        </div>
                    </div>
                    <div class="title">
                        <i class="dropdown icon"></i>
                        Топ-20 частых соперников
                    </div>
                    <div class="content">
                        <table class="ui unstackable selectable table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Имя</th>
                                    <th>Игр</th>
                                    <th>+</th>
                                    <th>=</th>
                                    <th>-</th>
                                </tr>
                            </thead>
                            <tbody id="opponents"></tbody>
                        </table>
                        Красным цветом отмечены соперники, с которым набрано менее 50% очков
                        Зеленым цветом отмечены соперники, с которыми набрано 50% очков и более
                    </div>
                    <div class="title">
                        <i class="dropdown icon"></i>
                        Топ-20 самых рейтинговых соперников которым не уступили
                    </div>
                    <div class="content">
                        <table class="ui unstackable selectable table">
                            <thead>
                                <tr>
                                    <th rowspan="2">#</th>
                                    <th rowspan="2">Соперник</th>
                                    <th colspan="2" class="center aligned">Рейтинг</th>
                                    <th rowspan="2">Дата</th>
                                    <th rowspan="2">Турнир</th>
                                    <th rowspan="2">Цвет</th>
                                    <th rowspan="2">Результат</th>
                                </tr>
                                <tr>
                                    <th>Игрока</th>
                                    <th>Соперника</th>
                                </tr>
                            </thead>
                            <tbody id="hardestGames"></tbody>
                        </table>
                    </div>
                    <div class="title">
                        <i class="dropdown icon"></i>
                        Топ-20 самых неудобных соперников
                    </div>
                    <div class="content">
                        <table class="ui unstackable selectable table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Соперник</th>
                                    <th>% очков</th>
                                    <th>+</th>
                                    <th>=</th>
                                    <th>-</th>
                                    <th>Игр</th>
                                </tr>
                            </thead>
                            <tbody id="inconvenientOpponent"></tbody>
                        </table>
                    </div>
                    <div class="title">
                        <i class="dropdown icon"></i>
                        Сила игры по ходу турнира
                    </div>
                    <div class="content" id="toursStats"></div>
                    <div class="title" onclick="$('.ui.modal').modal('show');">
                        <i class="caret right icon"></i>Обратная связь
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="ui tiny modal">
        <div class="header" style="">Обратная связь</div>
        <div class="content">
            Сообщения об ошибках, пожелания и предложения вы можете направлять по почте <a href="mailto:byte916@yandex.ru">byte916@yandex.ru</a> или через <a href="https://vk.com/id2962981" target="_blank">ВКонтакте</a>
        </div>
    </div>
    <a style="position: absolute; bottom: 0; right: 0" href="#" onclick="$('.ui.modal').modal('show');" class="ui tertiary big icon  button contacts">
        <i class="envelope icon"></i>
    </a>
</body>
</html>